<!doctype html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dashboard.css">

    <title>Laboratoire S5-GIF250</title>
    <!---<style>
        .sliderbutton {
            display: none;
        }
    </style>--->
</head>

<body>
    <!-- Menu BEGIN-->
    <nav class="navbar navbar-dark fb">
        <div class="container-fluid">
            <div class="col-sb">
                <h6 class="text-white h2">Racecar</h6>
            </div>
            <div class="col">
                <div class="row">
                    <h class="h6">User: </h>
                    <h class="h6" id="fieldUser"></h>
                </div>
                <div class="row">
                    <h class="h6">IP Address: </h>
                    <h class="h6" id="fieldIp"></h>
                </div>
            </div>
            <div class="col-sb">
                <form action="connection_page.html">
                    <input class="button_x" type="submit" value="X">
                </form>
            </div>

        </div>
    </nav>
    <!-- Menu END-->

    <!-- Main layout BEGIN-->
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <h6 class="text-black h1" style="font-weight: bold">Statut
                    <img src="img/loading.gif" id="connection_logo" width="30px" style="padding: px;">
                </h6>
                <textarea id='output' disabled rows="5" cols="30"></textarea>
                <div>
                    <button class="button-blue fb" value="Clear" onclick="javascript:eraseText();">Erase</button>
                </div>
            </div>
            <div class="col">
                <h6 class="text-black h1" style="font-weight: bold">Camera</h6>
                <img class="img-thumbnail" id="camRacecar"
                    src="http://localhost:8080/stream?topic=/racecar/raspicam_node/image&type=ros_compressed"
                    alt="Camera not working" width="480" height="auto">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h6 class="text-black h1" style="font-weight: bold">Control
                    <img alt="stop_button_img" src="img/emergency_button.png"
                        style="height: 85px; width: auto; cursor: pointer;" id="stop_button"
                        onclick="switchStopButtonImage()">
                </h6>
                <!---<label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider round" onclick="toggleSlider()"> </span>
                    </label>
                <canvas class="joystick" id="canvas" name="game"
                    onclick="{updateCmd(0.0, 0.0); addText('output', 'cmd');}"></canvas>
                <div class="sliderbutton">--->
                <button class="button_updown" onmousedown="Dpad_up()" onmouseup="Dpad_up_unlatch()">
                    <div class="triangle-up"></div>
                </button>
                <div></div>
                <button onmousedown="Dpad_left()" onmouseup="Dpad_left_unlatch()">
                    <div class="triangle-left"></div>
                </button>
                <button class="button_right" onmousedown="Dpad_right()" onmouseup="Dpad_right_unlatch()">
                    <div class="triangle-right"></div>
                </button>
                <div></div>
                <button class="button_updown" onmousedown="Dpad_down()" onmouseup="Dpad_down_unlatch()">
                    <div class="triangle-down"></div>
                </button>
            </div>
        </div>

    </div>
    </div>

    <!-- Main layout END-->

    <!-- JavaScript, import frameworks -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.3.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/roslib.min.js"></script> <!-- rosbridge -->

    <!-- Custom scripts -->
    <script>
        // Define some global variables
        var rbServer = null;
        var cmdVelTopic = null;

        var cmd_x = 0.0;
        var cmd_y = 0.0;

        function eraseText() {
            document.getElementById("output").value = "";
        }

        function addText(elId, text) {
            let elem = document.getElementById(elId);

            if (text == 'cmd') {
                elem.value += ('x: ' + cmd_x.toFixed(2) + '\ty:' + cmd_y.toFixed(2) + "\n");
            }
            else {
                elem.value += (text + "\n");
            }

            elem.scrollTop = elem.scrollHeight;
        }

        function updateCmd(x_relative, y_relative) {
            cmd_x = x_relative / 75.0;
            cmd_y = y_relative / 75.0;
        }

        //Some initializations after the page has been shown
        $(document).ready(function () {
            connectROS();
        });

        // Define some functions
        function connectROS(input) {
            // This function connects to the rosbridge server
            let url = window.location.href;
            let ip_regex = /(?<=ipAdd=)[^&]+/;
            let user_regex = /(?<=username=)[^&]+/;
            let ipadd;

            let ip_match = url.match(ip_regex);
            let user_match = url.match(user_regex);

            if (ip_match && user_match) {
                ipadd = ip_match[0];
                document.getElementById("fieldIp").textContent = ipadd;
                document.getElementById("fieldUser").textContent = user_match[0];
            }
            else {
                addText('output', 'Connexion error!');
                console.log('Error connecting to websocket server');
                document.getElementById("connection_logo").src = "img/connection_failed.png";
                return;
            }


            addText('output', 'Trying to connect...');

            rbServer = new ROSLIB.Ros({
                // Assuming ros server IP is 10.42.0.1
                // url: 'ws://10.42.0.1:9090'
                url: 'ws://' + ipadd + ':9090'
            });

            rbServer.on('connection', function () {
                console.log('Connected to websocket server.');
                addText('output', 'Connected!');
                document.getElementById("connection_logo").src = "img/connection_established.png";

                // These lines create a topic object as defined by roslibjs
                cmdVelTopic = new ROSLIB.Topic({
                    ros: rbServer,
                    name: '/racecar/cmd_vel',
                    messageType: 'geometry_msgs/Twist'
                });
            });

            rbServer.on('error', function (error) {
                addText('output', 'Connexion error!');
                console.log('Error connecting to websocket server: ', error);
                document.getElementById("connection_logo").src = "img/connection_failed.png";
            });

            rbServer.on('close', function () {
                addText('output', 'Connexion closed!');
                console.log('Connection to websocket server closed.');
                document.getElementById("connection_logo").src = "img/connection_failed.png";
            });
        }

        // These lines create a message that conforms to the structure of the Twist defined in our ROS installation
        // It initalizes all properties to zero. They will be set to appropriate values before we publish this message.
        var twist = new ROSLIB.Message({
            linear: {
                x: 0.0,
                y: 0.0,
                z: 0.0
            },
            angular: {
                x: 0.0,
                y: 0.0,
                z: 0.0
            }
        });

        //Publishing loop cmd_vel at 5 Hz
        setInterval(function () {
            if (cmdVelTopic != null) {
                twist.linear.x = cmd_x;
                twist.angular.z = cmd_y;
                cmdVelTopic.publish(twist);
            }

        }, 200);

        let flag_SB = 0;
        function switchStopButtonImage() {
            if (flag_SB) {
                document.getElementById("stop_button").src = "img/emergency_button.png";
                addText('output', 'Stop button released!');
            } else {
                document.getElementById("stop_button").src = "img/emergency_button.gif";
                addText('output', 'Stop button pushed!');
            }
            flag_SB = !flag_SB;
        }

        function disableScroll() {
            let scrollXoffset = window.pageXOffset();
            let scrollYoffset = window.pageYOffset();
            window.onscroll = function () { window.scrollTo(scrollXoffset, scrollYoffset) };
        }

        function enableScroll() {
            window.onscroll = function () { };
        }

        /*var canvas, ctx;
        window.addEventListener('load', () => {

            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resize();

            document.addEventListener('mousedown', startDrawing);
            document.addEventListener('mouseup', stopDrawing);
            document.addEventListener('mousemove', Draw);

            document.addEventListener('touchstart', startDrawing);
            document.addEventListener('touchend', stopDrawing);
            document.addEventListener('touchcancel', stopDrawing);
            document.addEventListener('touchmove', Draw);
            window.addEventListener('resize', resize);
        });

        var width, height, radius, x_orig, y_orig;
        function resize() {
            radius = 75;
            width = radius * 4;
            height = radius * 6.5;
            ctx.canvas.width = window.innerWidth / 2;
            ctx.canvas.height = height;
            background();
            joystick(width / 2, height / 3);
        }

        function background() {
            x_orig = radius * 2;
            y_orig = height / 3;

            ctx.beginPath();
            ctx.arc(x_orig, y_orig, radius + 20, 0, Math.PI * 2, true);
            ctx.fillStyle = '#CAD6F0';
            ctx.fill();
        }

        function joystick(width, height) {
            ctx.beginPath();
            ctx.arc(width, height, radius, 0, Math.PI * 2, true);
            ctx.fillStyle = '#3B5998';
            ctx.fill();
            ctx.strokeStyle = '#5478C2';
            ctx.lineWidth = 8;
            ctx.stroke();
        }

        let coord = { x: 0, y: 0 };
        let paint = false;

        function getPosition(event) {
            var mouse_x = event.clientX || event.touches[0].clientX;
            var mouse_y = event.clientY || event.touches[0].clientY;
            coord.x = mouse_x - canvas.offsetLeft;
            coord.y = mouse_y - canvas.offsetTop - 485;
        }

        function is_it_in_the_circle() {
            var current_radius = Math.sqrt(Math.pow(coord.x - x_orig, 2) + Math.pow(coord.y - y_orig, 2));
            if (radius >= current_radius) return true
            else return false
        }


        function startDrawing(event) {
            paint = true;
            getPosition(event);
            if (is_it_in_the_circle()) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                background();
                joystick(coord.x, coord.y);
                Draw();
            }
        }

        function stopDrawing() {
            paint = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            background();
            joystick(width / 2, height / 3);
        }

        function Draw(event) {

            if (paint) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                background();
                var angle_in_degrees, x, y, speed;
                var angle = Math.atan2((coord.y - y_orig), (coord.x - x_orig));

                if (Math.sign(angle) == -1) {
                    angle_in_degrees = Math.round(-angle * 180 / Math.PI);
                }
                else {
                    angle_in_degrees = Math.round(360 - angle * 180 / Math.PI);
                }

                if (is_it_in_the_circle()) {
                    joystick(coord.x, coord.y);
                    x = coord.x;
                    y = coord.y;
                }
                else {
                    x = radius * Math.cos(angle) + x_orig;
                    y = radius * Math.sin(angle) + y_orig;
                    joystick(x, y);
                }

                getPosition(event);
                var speed = Math.round(100 * Math.sqrt(Math.pow(x - x_orig, 2) + Math.pow(y - y_orig, 2)) / radius);
                var x_relative = Math.round(x - x_orig);
                var y_relative = Math.round(y - y_orig);

                updateCmd(-y_relative, x_relative);
                addText('output', 'cmd');
            }
        }
*/

        const delay = 100;

        let dpadup_pressed = false;
        function Dpad_up() {
            dpadup_pressed = true;
            const up_repeat = () => {
                if (dpadup_pressed) {
                    setTimeout(up_repeat, delay);
                    cmd_x = 1.0;
                    addText('output', 'cmd');
                    console.log("Dpad_up_Pressed");
                }
            }
            up_repeat();
        }
        function Dpad_up_unlatch() {
            dpadup_pressed = false;
            cmd_x = 0.0;
            addText('output', 'cmd');
            console.log("Dpad_up_NOT_ressed")
        }

        let dpaddown_pressed = false;
        function Dpad_down() {
            dpaddown_pressed = true;
            const down_repeat = () => {
                if (dpaddown_pressed) {
                    setTimeout(down_repeat, delay);
                    cmd_x = -1.0;
                    addText('output', 'cmd');
                    console.log("Dpad_down_Pressed");
                }
            }
            down_repeat();
        }
        function Dpad_down_unlatch() {
            dpaddown_pressed = false;
            cmd_x = 0.0;
            addText('output', 'cmd');
            console.log("Dpad_down_NOT_ressed")
        }

        let dpadright_pressed = false;
        function Dpad_right() {
            dpadright_pressed = true;
            const right_repeat = () => {
                if (dpadright_pressed) {
                    setTimeout(right_repeat, delay);
                    cmd_y = 1.0;
                    addText('output', 'cmd');
                    console.log("Dpad_right Pressed");
                }
            }
            right_repeat();
        }
        function Dpad_right_unlatch() {
            dpadright_pressed = false;
            cmd_y = 0.0;
            addText('output', 'cmd');
            console.log("Dpad_right_NOT_ressed")
        }

        let dpadleft_pressed = false;
        function Dpad_left() {
            dpadleft_pressed = true;
            const left_repeat = () => {
                if (dpadleft_pressed) {
                    setTimeout(left_repeat, delay);
                    cmd_y = -1.0;
                    addText('output', 'cmd');
                    console.log("Dpad_left Pressed");
                }
            }
            left_repeat();
        }
        function Dpad_left_unlatch() {
            dpadleft_pressed = false;
            cmd_y = 0.0;
            addText('output', 'cmd');

            console.log("Dpad_left_NOT_ressed")
        }

        let flag_slider = 0;
        function toggleSlider() {
            if (flag_slider) {
                document.querySelector('.joystick').style.display = 'block';
                $("#canvas *").attr("disabled", "disabled").off('click');

                document.querySelector('.sliderbutton').style.display = 'none';
            } else {
                document.querySelector('.joystick').style.display = 'none';
                document.querySelector('.sliderbutton').style.display = 'block';
            }
            flag_slider = !flag_slider;
        }

    </script>
</body>

</html>
